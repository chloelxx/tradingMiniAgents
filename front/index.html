<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingMiniAgents - è‚¡ç¥¨åˆ†ææ™ºèƒ½ä½“</title>
    <link rel="icon" href="./images/image.png" type="image/png">
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <!-- Element Plus Icons -->
    <link rel="stylesheet" href="https://unpkg.com/@element-plus/icons-vue/dist/index.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            color: #303133;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #909399;
            font-size: 14px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-item {
            display: flex;
            flex-direction: column;
        }

        .form-item label {
            margin-bottom: 8px;
            color: #606266;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .analyst-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analyst-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .analyst-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 2px solid #e4e7ed;
            cursor: pointer;
            transition: all 0.3s;
        }

        .analyst-item:hover {
            border-color: #409eff;
            background: #ecf5ff;
        }

        .analyst-item.selected {
            border-color: #409eff;
            background: #ecf5ff;
        }

        .analyst-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .info-box {
            background: #f0f9ff;
            border: 1px solid #b3d8ff;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            color: #409eff;
            font-size: 13px;
        }

        .success-box {
            background: #f0f9ff;
            border: 1px solid #b3d8ff;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            color: #67c23a;
            font-size: 13px;
        }

        .action-button {
            width: 100%;
            height: 50px;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
        }

        .results-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
        }

        .result-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-item h3 {
            color: #303133;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e4e7ed;
        }

        .result-content {
            color: #606266;
            line-height: 1.8;
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 20px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #909399;
        }

        .depth-indicator {
            text-align: center;
            margin-top: 10px;
            color: #606266;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>ğŸ“Š TradingMiniAgents</h1>
                <p>ç®€åŒ–ç‰ˆè‚¡ç¥¨åˆ†ææ™ºèƒ½ä½“ç³»ç»Ÿ</p>
            </div>

            <!-- è¡¨å•åŒºåŸŸ -->
            <el-form :model="form" label-width="120px">
                <!-- ç¬¬ä¸€è¡Œï¼šå¸‚åœºå’Œè‚¡ç¥¨ä»£ç  -->
                <div class="form-row">
                    <div class="form-item">
                        <label>
                            <el-icon>
                                <Globe />
                            </el-icon>
                            é€‰æ‹©å¸‚åœº
                        </label>
                        <el-select v-model="form.market" placeholder="è¯·é€‰æ‹©å¸‚åœº" style="width: 100%">
                            <el-option label="Aè‚¡" value="Aè‚¡" />
                            <el-option label="æ¸¯è‚¡" value="æ¸¯è‚¡" />
                            <el-option label="ç¾è‚¡" value="ç¾è‚¡" />
                        </el-select>
                    </div>

                    <div class="form-item">
                        <label>
                            <el-icon>
                                <TrendCharts />
                            </el-icon>
                            è‚¡ç¥¨ä»£ç 
                        </label>
                        <el-input v-model="form.ticker" placeholder="è¯·è¾“å…¥è‚¡ç¥¨ä»£ç " clearable />
                    </div>
                </div>

                <!-- ç¬¬äºŒè¡Œï¼šåˆ†ææ—¥æœŸå’Œç ”ç©¶æ·±åº¦ -->
                <div class="form-row">
                    <div class="form-item">
                        <label>
                            <el-icon>
                                <Calendar />
                            </el-icon>
                            åˆ†ææ—¥æœŸ
                        </label>
                        <el-date-picker v-model="form.date" type="date" placeholder="é€‰æ‹©åˆ†ææ—¥æœŸ" format="YYYY/MM/DD"
                            value-format="YYYY-MM-DD" style="width: 100%" />
                    </div>

                    <div class="form-item">
                        <label>
                            <el-icon>
                                <Search />
                            </el-icon>
                            ç ”ç©¶æ·±åº¦
                        </label>
                        <el-slider v-model="form.research_depth" :min="1" :max="5" :step="1" show-stops show-input />
                        <div class="depth-indicator">
                            {{ getDepthText(form.research_depth) }}
                        </div>
                    </div>
                </div>

                <!-- åˆ†æå¸ˆé€‰æ‹© -->
                <div class="form-section">
                    <div class="analyst-section">
                        <h3 style="margin-bottom: 15px; color: #303133;">
                            <el-icon>
                                <User />
                            </el-icon>
                            é€‰æ‹©åˆ†æå¸ˆå›¢é˜Ÿ
                        </h3>

                        <div class="analyst-options">
                            <div class="analyst-item" :class="{ selected: form.analysts.includes('market') }"
                                @click="toggleAnalyst('market')">
                                <input type="checkbox" :checked="form.analysts.includes('market')"
                                    @change="toggleAnalyst('market')" />
                                <el-icon style="margin-right: 8px; color: #409eff;">
                                    <TrendCharts />
                                </el-icon>
                                <span>å¸‚åœºåˆ†æå¸ˆ</span>
                            </div>

                            <div class="analyst-item" :class="{ selected: form.analysts.includes('fundamentals') }"
                                @click="toggleAnalyst('fundamentals')">
                                <input type="checkbox" :checked="form.analysts.includes('fundamentals')"
                                    @change="toggleAnalyst('fundamentals')" />
                                <el-icon style="margin-right: 8px; color: #67c23a;">
                                    <Money />
                                </el-icon>
                                <span>åŸºæœ¬é¢åˆ†æå¸ˆ</span>
                            </div>
                        </div>

                        <div class="success-box" v-if="form.analysts.length > 0">
                            <el-icon>
                                <Check />
                            </el-icon>
                            å·²é€‰æ‹© {{ form.analysts.length }} ä¸ªåˆ†æå¸ˆ: {{ getAnalystNames() }}
                        </div>

                        <div class="info-box" v-if="form.market === 'Aè‚¡' && form.analysts.includes('social')">
                            <el-icon>
                                <InfoFilled />
                            </el-icon>
                            Aè‚¡å¸‚åœºæš‚ä¸æ”¯æŒç¤¾äº¤åª’ä½“åˆ†æ, å› ä¸ºå›½å†…æ•°æ®æºé™åˆ¶
                        </div>
                    </div>
                </div>

                <!-- ç¡®è®¤ä¿¡æ¯ -->
                <div class="success-box" v-if="form.ticker">
                    <el-icon>
                        <Check />
                    </el-icon>
                    å·²è¾“å…¥è‚¡ç¥¨ä»£ç : {{ form.ticker }}
                </div>

                <!-- è¾“å‡ºæ¨¡å¼é€‰æ‹© -->
                <div class="analyst-section"
                    style="background: #fff7e6; border: 1px solid #ffe7ba; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #ad6800;">
                        <el-icon>
                            <Setting />
                        </el-icon>
                        è¾“å‡ºæ¨¡å¼é€‰æ‹©
                    </h3>
                    <el-radio-group v-model="useStreaming" style="margin-bottom: 10px;">
                        <el-radio :label="true">
                            <span style="margin-left: 5px;">
                                <el-icon style="color: #409eff; margin-right: 5px;">
                                    <VideoPlay />
                                </el-icon>
                                æµå¼è¾“å‡º (æ¨è)
                            </span>
                        </el-radio>
                        <el-radio :label="false" style="margin-left: 20px;">
                            <span style="margin-left: 5px;">
                                <el-icon style="color: #67c23a; margin-right: 5px;">
                                    <DocumentCopy />
                                </el-icon>
                                åŒæ­¥è¾“å‡º (ä¸€æ¬¡æ€§)
                            </span>
                        </el-radio>
                    </el-radio-group>
                    <div class="info-box" style="margin-top: 10px; font-size: 12px;">
                        <el-icon style="vertical-align: middle;">
                            <InfoFilled />
                        </el-icon>
                        <span style="margin-left: 5px;">
                            {{ useStreaming ? 'æµå¼è¾“å‡ºï¼šå®æ—¶æ˜¾ç¤ºåˆ†æç»“æœï¼Œç”¨æˆ·ä½“éªŒæ›´ä½³' : 'åŒæ­¥è¾“å‡ºï¼šç­‰å¾…å®Œæ•´ç»“æœåä¸€æ¬¡æ€§æ˜¾ç¤ºï¼Œå…¼å®¹æ€§æ›´å¥½' }}
                        </span>
                    </div>
                </div>

                <!-- å¼€å§‹åˆ†ææŒ‰é’® -->
                <el-button type="primary" size="large" class="action-button" :loading="loading" @click="startAnalysis"
                    :disabled="!canAnalyze">
                    <el-icon>
                        <Promotion />
                    </el-icon>
                    {{ loading ? 'åˆ†æä¸­...' : 'å¼€å§‹åˆ†æ' }}
                </el-button>
            </el-form>

            <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div class="results-section" v-if="results || loading">
                <h2 style="margin-bottom: 20px; color: #303133;">åˆ†æç»“æœ</h2>

                <!-- å®æ—¶æ˜¾ç¤ºç»“æœï¼ˆæ”¯æŒæµå¼é€æ­¥æ›´æ–°ï¼‰ -->
                <div v-if="results" style="margin-bottom: 20px;">
                    <div class="result-item" v-for="(report, analyst) in results" :key="analyst">
                        <h3>
                            {{ analyst }}
                            <el-icon v-if="loading && !streamsCompleted[analyst]" class="is-loading"
                                style="font-size: 16px; margin-left: 8px;">
                                <Loading />
                            </el-icon>
                            <el-icon v-else-if="streamsCompleted[analyst]"
                                style="font-size: 16px; margin-left: 8px; color: #67c23a;">
                                <SuccessFilled />
                            </el-icon>
                        </h3>
                        <div class="result-content">{{ report }}</div>
                    </div>
                </div>

                <!-- åŠ è½½ä¸­æç¤ºï¼ˆä»…åœ¨å®Œå…¨æ²¡æœ‰ç»“æœæ—¶æ˜¾ç¤ºï¼‰ -->
                <div v-if="loading && !results" class="loading">
                    <el-icon class="is-loading" style="font-size: 32px;">
                        <Loading />
                    </el-icon>
                    <p style="margin-top: 15px;">{{ loadingMessage }}</p>
                </div>

                <div v-if="error"
                    style="background: #fef0f0; border: 1px solid #fbc4c4; border-radius: 6px; padding: 15px; color: #f56c6c; margin-top: 20px;">
                    <el-icon>
                        <Warning />
                    </el-icon>
                    {{ error }}
                </div>
            </div>
        </div>
    </div>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <!-- Element Plus Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue/dist/index.iife.js"></script>

    <script>
        const { createApp } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            data() {
                return {
                    form: {
                        market: 'Aè‚¡',
                        ticker: '300748',
                        date: new Date().toISOString().split('T')[0],
                        research_depth: 3,
                        analysts: ['market', 'fundamentals']
                    },
                    loading: false,
                    loadingMessage: 'æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...',
                    results: null,
                    error: null,
                    apiBaseUrl: '',  // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œå› ä¸ºå‰åç«¯åœ¨åŒä¸€ç«¯å£
                    useStreaming: true,  // æ˜¯å¦ä½¿ç”¨æµå¼è¾“å‡º
                    streamsCompleted: {}  // è·Ÿè¸ªå„åˆ†æå¸ˆçš„å®ŒæˆçŠ¶æ€
                };
            },
            computed: {
                canAnalyze() {
                    return this.form.ticker && this.form.date && this.form.analysts.length > 0 && !this.loading;
                }
            },
            methods: {
                toggleAnalyst(analyst) {
                    const index = this.form.analysts.indexOf(analyst);
                    if (index > -1) {
                        this.form.analysts.splice(index, 1);
                    } else {
                        this.form.analysts.push(analyst);
                    }
                },
                getAnalystNames() {
                    const names = {
                        'market': 'å¸‚åœºåˆ†æå¸ˆ',
                        'fundamentals': 'åŸºæœ¬é¢åˆ†æå¸ˆ',
                        'news': 'æ–°é—»åˆ†æå¸ˆ',
                        'social': 'ç¤¾äº¤åª’ä½“åˆ†æå¸ˆ'
                    };
                    return this.form.analysts.map(a => names[a] || a).join(', ');
                },
                getDepthText(depth) {
                    const texts = {
                        1: '1çº§ - å¿«é€Ÿåˆ†æ',
                        2: '2çº§ - åŸºç¡€åˆ†æ',
                        3: '3çº§ - æ ‡å‡†åˆ†æ',
                        4: '4çº§ - æ·±åº¦åˆ†æ',
                        5: '5çº§ - å…¨é¢åˆ†æ'
                    };
                    return texts[depth] || `${depth}çº§`;
                },
                async startAnalysis() {
                    if (!this.canAnalyze) {
                        ElMessage.warning('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                        return;
                    }

                    this.loading = true;
                    this.error = null;
                    this.results = {};  // åˆå§‹åŒ–ä¸ºç©ºå¯¹è±¡ï¼Œæ”¯æŒé€æ­¥æ›´æ–°
                    this.streamsCompleted = {};  // é‡ç½®å®ŒæˆçŠ¶æ€
                    this.loadingMessage = 'æ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...';

                    try {
                        const requestData = {
                            ticker: this.form.ticker,
                            date: this.form.date,
                            market: this.form.market,
                            analysts: this.form.analysts,
                            research_depth: this.form.research_depth
                        };

                        // æ ¹æ®æ¨¡å¼é€‰æ‹©ä¸åŒçš„å¤„ç†æ–¹å¼
                        if (this.useStreaming) {
                            await this.analyzeStream(requestData);
                        } else {
                            await this.analyzeSyncV1(requestData);
                        }

                        ElMessage.success('åˆ†æå®Œæˆï¼');
                    } catch (error) {
                        console.error('åˆ†æé”™è¯¯:', error);
                        this.error = error.message || 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€';
                        ElMessage.error(this.error);
                    } finally {
                        this.loading = false;
                    }
                },
                async analyzeStream(requestData) {
                    /**
                     * æµå¼åˆ†æ - å®æ—¶æ˜¾ç¤ºç»“æœ
                     */
                    const url = `${this.apiBaseUrl}/api/analyze-stream`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    if (!this.results) {
                        this.results = {};
                    }

                    let currentAnalyst = null;
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n\n');
                        buffer = lines[lines.length - 1];

                        for (let i = 0; i < lines.length - 1; i++) {
                            const line = lines[i].trim();
                            if (line.startsWith('data: ')) {
                                try {
                                    const jsonStr = line.slice(6);

                                    // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ JSON
                                    if (!jsonStr || jsonStr === '') {
                                        continue;
                                    }

                                    const data = JSON.parse(jsonStr);
                                    if (data.event === 'start') {
                                        this.loadingMessage = 'âœ¨ åˆ†æå¼€å§‹...';
                                    } else if (data.event === 'analyst_start') {
                                        currentAnalyst = data.analyst;
                                        this.results[currentAnalyst] = '';
                                        this.$set(this.streamsCompleted, currentAnalyst, false);
                                        this.loadingMessage = `ğŸ“Š ${currentAnalyst}åˆ†æä¸­...`;
                                    } else if (data.event === 'content') {
                                        if (currentAnalyst && data.chunk) {
                                            this.results[currentAnalyst] += data.chunk;
                                            this.$set(this.results, currentAnalyst, this.results[currentAnalyst]);
                                        }
                                    } else if (data.event === 'analyst_end') {
                                        if (currentAnalyst) {
                                            this.$set(this.streamsCompleted, currentAnalyst, true);
                                        }
                                        this.loadingMessage = `âœ… ${data.analyst} åˆ†æå®Œæˆ`;
                                    } else if (data.event === 'complete') {
                                        this.loadingMessage = 'âœ¨ åˆ†æå®Œæˆï¼';
                                    } else if (data.event === 'error') {
                                        throw new Error(data.message || 'åˆ†æå‡ºé”™');
                                    }
                                } catch (e) {
                                    console.error('è§£æ SSE æ¶ˆæ¯å¤±è´¥:', line, e);
                                    // ç»§ç»­å¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼Œä¸ä¸­æ–­æµç¨‹
                                }
                            }
                        }
                    }

                    // å¤„ç†æœ€åçš„æ•°æ®
                    if (buffer.trim().startsWith('data: ')) {
                        try {
                            const data = JSON.parse(buffer.trim().slice(6));
                            if (data.event === 'content' && currentAnalyst) {
                                this.results[currentAnalyst] += data.chunk;
                            }
                        } catch (e) {
                            console.error('è§£ææœ€åçš„ SSE æ¶ˆæ¯å¤±è´¥:', e);
                        }
                    }
                },
                async analyzeSyncV1(requestData) {
                    /**
                     * åŒæ­¥åˆ†æ - ä¸€æ¬¡æ€§è·å–å®Œæ•´ç»“æœ
                     */
                    const url = `${this.apiBaseUrl}/api/analyze`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `HTTP ${response.status}`);
                    }

                    const data = await response.json();

                    if (!data.success) {
                        throw new Error(data.message || 'åˆ†æå¤±è´¥');
                    }

                    // è½¬æ¢ç»“æœæ ¼å¼ä¸ºä¸æµå¼ç›¸åŒçš„ç»“æ„
                    this.results = data.data.reports;
                    this.loadingMessage = 'âœ¨ åˆ†æå®Œæˆï¼';
                },
                async checkApiConnection() {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ—¶

                        const response = await fetch(`${this.apiBaseUrl}/health`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const data = await response.json();
                        console.log('API å¥åº·çŠ¶æ€:', data);

                        if (!data.mongodb_connected) {
                            ElMessage.warning('MongoDB æœªè¿æ¥ï¼Œåˆ†æç»“æœå°†ä¸ä¼šä¿å­˜');
                        } else {
                            ElMessage.success('API æœåŠ¡å™¨è¿æ¥æˆåŠŸ');
                        }
                    } catch (err) {
                        console.error('API è¿æ¥å¤±è´¥:', err);
                        let errorMsg = 'æ— æ³•è¿æ¥åˆ° API æœåŠ¡å™¨';

                        if (err.name === 'AbortError' || err.name === 'TimeoutError') {
                            errorMsg = 'API æœåŠ¡å™¨è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å·²å¯åŠ¨ï¼ˆç«¯å£ 8000ï¼‰';
                        } else if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
                            errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ï¼špython api_server.py æˆ– python start_server.py';
                        } else {
                            errorMsg = `è¿æ¥é”™è¯¯: ${err.message}`;
                        }

                        ElMessage.error(errorMsg);
                        this.error = errorMsg;
                    }
                }
            },
            mounted() {
                // æ£€æŸ¥ API è¿æ¥
                this.checkApiConnection();
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>

</html>