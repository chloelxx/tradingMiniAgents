# TradingMiniAgents é¡¹ç›®æ¶æ„ä¸æµç¨‹åˆ†æ

## ğŸ“ ç³»ç»Ÿæ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç”¨æˆ·æµè§ˆå™¨ (Vue3)                       â”‚
â”‚                     front/index.html                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ é€‰æ‹©è‚¡ç¥¨ â†’ é€‰æ‹©åˆ†æå¸ˆ â†’ é€‰æ‹©æ¨¡å¼ â†’ ç‚¹å‡»åˆ†æ              â”‚
â”‚  â”‚ (dropdown)  (checkbox)   (radio)   (button)             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“ HTTP POST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FastAPI åç«¯æœåŠ¡å™¨                         â”‚
â”‚              api_server.py (Port: 8001)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ @app.post("/api/analyze")          åŒæ­¥åˆ†æ             â”‚
â”‚  â”‚ @app.post("/api/analyze-stream")   æµå¼åˆ†æ             â”‚
â”‚  â”‚ @app.get("/api/history")           å†å²è®°å½•             â”‚
â”‚  â”‚ @app.get("/api/stock-info")        è‚¡ç¥¨ä¿¡æ¯             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“                      â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   åŒæ­¥åˆ†ææµç¨‹   â”‚  â”‚   æµå¼åˆ†ææµç¨‹   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ ¸å¿ƒåˆ†æå¼•æ“ (core/)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  AnalystManager      â”‚  â”‚ AnalystManagerStream â”‚        â”‚
â”‚  â”‚  (åŒæ­¥ç®¡ç†å™¨)        â”‚  â”‚ (å¼‚æ­¥ç®¡ç†å™¨)         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â†“                              â†“                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚MarketAnalyst â”‚  â”‚Fundamentalsâ”‚  â”‚   Stream     â”‚       â”‚
â”‚   â”‚  (æŠ€æœ¯é¢)  â”‚  â”‚  Analyst   â”‚  â”‚  Versions    â”‚       â”‚
â”‚   â”‚  - è¶‹åŠ¿    â”‚  â”‚  (åŸºæœ¬é¢)  â”‚  â”‚              â”‚       â”‚
â”‚   â”‚  - æŒ‡æ ‡    â”‚  â”‚  - è´¢åŠ¡    â”‚  â”‚ (å¼‚æ­¥ç‰ˆæœ¬)   â”‚       â”‚
â”‚   â”‚  - æˆäº¤é‡  â”‚  â”‚  - ä¼°å€¼    â”‚  â”‚              â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“                      â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   æ•°æ®è·å–å±‚     â”‚  â”‚  LLM åˆ†æå±‚      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“                      â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  StockDataProvider     â”‚  â”‚  DeepSeekClient      â”‚
    â”‚  (æ•°æ®/stock_data.py)  â”‚  â”‚  (core/llm_client)   â”‚
    â”‚                        â”‚  â”‚                      â”‚
    â”‚ â€¢ get_stock_info()     â”‚  â”‚ â€¢ _chat()            â”‚
    â”‚ â€¢ get_market_info()    â”‚  â”‚ â€¢ analyze_stream()   â”‚
    â”‚ â€¢ get_market_data()    â”‚  â”‚ â€¢ HTTP è¯·æ±‚          â”‚
    â”‚ â€¢ get_daily_data()     â”‚  â”‚                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“                            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚æ•°æ®æº        â”‚        â”‚ DeepSeek API         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚ (Cloud LLM Service)  â”‚
    â”‚â€¢ akshare     â”‚        â”‚                      â”‚
    â”‚â€¢ baostock    â”‚        â”‚ ç”¨æ¨¡å‹åˆ†æè‚¡ç¥¨æ•°æ®   â”‚
    â”‚â€¢ tushare     â”‚        â”‚ ç”Ÿæˆåˆ†ææŠ¥å‘Š         â”‚
    â”‚â€¢ yfinance    â”‚        â”‚                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“                            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚âœ“ å®æ—¶è¡Œæƒ…    â”‚        â”‚âœ“ æ–‡æœ¬åˆ†æ            â”‚
    â”‚âœ“ å†å²æ•°æ®    â”‚        â”‚âœ“ æŠ€æœ¯æŒ‡æ ‡è§£è¯»        â”‚
    â”‚âœ“ åŸºæœ¬é¢æ•°æ®  â”‚        â”‚âœ“ æŠ•èµ„å»ºè®®ç”Ÿæˆ        â”‚
    â”‚âœ“ è´¢åŠ¡æ•°æ®    â”‚        â”‚âœ“ ä¸­æ–‡æŠ¥å‘Šè¾“å‡º        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    å­˜å‚¨å±‚ (storage/)   â”‚
        â”‚  MongoDBStorage        â”‚
        â”‚                        â”‚
        â”‚ â€¢ save_analysis_report â”‚
        â”‚ â€¢ get_analysis_reports â”‚
        â”‚ â€¢ MongoDB æ•°æ®åº“       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   MongoDB æ•°æ®åº“       â”‚
        â”‚ (collections:         â”‚
        â”‚  - analysis_reports   â”‚
        â”‚  - user_preferences)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å…¨å±€å˜é‡åˆå§‹åŒ–æµç¨‹

```
ç¨‹åºå¯åŠ¨ (main in api_server.py)
    â†“
åŠ è½½ç¯å¢ƒå˜é‡ (load_dotenv())
    â†“
åˆ›å»º FastAPI åº”ç”¨å¯¹è±¡
    â†“
æ·»åŠ  CORS ä¸­é—´ä»¶é…ç½®
    â†“
å£°æ˜å…¨å±€å˜é‡ (None åˆå§‹åŒ–)
    â”œâ”€â”€ llm_client = None
    â”œâ”€â”€ data_provider = None
    â”œâ”€â”€ analyst_manager = None
    â”œâ”€â”€ analyst_manager_stream = None
    â”œâ”€â”€ mongodb_storage = None
    â””â”€â”€ image_analyzer = None
    â†“
    ğŸ”´ æ­¤æ—¶æ‰€æœ‰å…¨å±€å˜é‡éƒ½æ˜¯ Noneï¼Œæ— æ³•ä½¿ç”¨
    â†“
@app.on_event("startup") è§¦å‘
    â†“
æ‰§è¡Œ init_components() å‡½æ•°
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆå§‹åŒ–è¿‡ç¨‹ (init_components å‡½æ•°):                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ 1ï¸âƒ£  llm_client = DeepSeekClient()                      â”‚
â”‚     â†“                                                    â”‚
â”‚     ä» .env è¯»å–:                                       â”‚
â”‚     - DEEPSEEK_API_KEY                                  â”‚
â”‚     - DEEPSEEK_BASE_URL                                 â”‚
â”‚     - DEEPSEEK_MODEL                                    â”‚
â”‚     - DEEPSEEK_TEMPERATURE                              â”‚
â”‚     - DEEPSEEK_MAX_TOKENS                               â”‚
â”‚     âœ… åˆ›å»º httpx å®¢æˆ·ç«¯ï¼Œå‡†å¤‡è°ƒç”¨ DeepSeek API        â”‚
â”‚                                                          â”‚
â”‚ 2ï¸âƒ£  data_provider = StockDataProvider()                â”‚
â”‚     â†“                                                    â”‚
â”‚     åˆå§‹åŒ–å¸‚åœºä¿¡æ¯ (Aè‚¡/æ¸¯è‚¡/ç¾è‚¡)                      â”‚
â”‚     âœ… å‡†å¤‡æ•°æ®è·å–                                     â”‚
â”‚                                                          â”‚
â”‚ 3ï¸âƒ£  analyst_manager = AnalystManager(...)              â”‚
â”‚     â†“                                                    â”‚
â”‚     æ¥æ”¶: llm_client, data_provider                      â”‚
â”‚     åˆ›å»º: MarketAnalyst + FundamentalsAnalyst           â”‚
â”‚     âœ… å‡†å¤‡åŒæ­¥åˆ†æ                                     â”‚
â”‚                                                          â”‚
â”‚ 4ï¸âƒ£  analyst_manager_stream = AnalystManagerStream(...) â”‚
â”‚     â†“                                                    â”‚
â”‚     æ¥æ”¶: llm_client, data_provider                      â”‚
â”‚     åˆ›å»º: MarketAnalystStream + FundamentalsAnalystStream
â”‚     âœ… å‡†å¤‡æµå¼åˆ†æ                                     â”‚
â”‚                                                          â”‚
â”‚ 5ï¸âƒ£  mongodb_storage = MongoDBStorage()                 â”‚
â”‚     â†“                                                    â”‚
â”‚     å°è¯•è¿æ¥ MongoDB                                    â”‚
â”‚     âœ… å¦‚æœè¿æ¥æˆåŠŸï¼Œå‡†å¤‡ä¿å­˜æ•°æ®                       â”‚
â”‚                                                          â”‚
â”‚ 6ï¸âƒ£  image_analyzer = ImageAnalyzer(llm_client)        â”‚
â”‚     â†“                                                    â”‚
â”‚     æ¥æ”¶: llm_client                                    â”‚
â”‚     âœ… å‡†å¤‡å›¾ç‰‡åˆ†æ                                     â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ‰€æœ‰ç»„ä»¶åˆå§‹åŒ–å®Œæˆ
    â†“
    ğŸŸ¢ ç°åœ¨æ‰€æœ‰å…¨å±€å˜é‡éƒ½å¯ä»¥ä½¿ç”¨äº†
    â†“
HTTP è¯·æ±‚åˆ°è¾¾ API ç«¯ç‚¹
    â†“
ä½¿ç”¨å…¨å±€å˜é‡å¤„ç†è¯·æ±‚
```

---

## ğŸ“‹ åŒæ­¥åˆ†ææµç¨‹ï¼ˆ@app.post("/api/analyze")ï¼‰

```
å®¢æˆ·ç«¯å‘é€ HTTP POST è¯·æ±‚
    â†“
    {
        "ticker": "300748",
        "date": "2024-01-01",
        "market": "Aè‚¡",
        "analysts": ["market", "fundamentals"],
        "research_depth": 3,
        "image_path": null
    }
    â†“
async def analyze_stock(request: AnalysisRequest)
    â†“
    âœ… éªŒè¯è¯·æ±‚å‚æ•°
    â”œâ”€â”€ ticker ä¸ä¸ºç©ºï¼Ÿ
    â”œâ”€â”€ date ä¸ä¸ºç©ºï¼Ÿ
    â””â”€â”€ image_path æ˜¯å¦æœ‰æ•ˆï¼Ÿ
    â†“
    ğŸ–¼ï¸  å¦‚æœæä¾› image_path:
    â”œâ”€ image_analyzer.analyze_image()
    â””â”€ è°ƒç”¨ LLM åˆ†æå›¾ç‰‡ (å¯é€‰)
    â†“
    ğŸ“Š è°ƒç”¨åŒæ­¥åˆ†æ:
    reports = analyst_manager.analyze(
        ticker="300748",
        date="2024-01-01",
        market="Aè‚¡",
        analysts=["market", "fundamentals"]
    )
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AnalystManager.analyze() å¤„ç†æµç¨‹:                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ åˆå§‹åŒ–ç»“æœå­—å…¸ reports = {}                             â”‚
â”‚                                                          â”‚
â”‚ å¯¹äºæ¯ä¸ªåˆ†æå¸ˆ ("market" / "fundamentals"):             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚                                                   â”‚  â”‚
â”‚ â”‚ 1ï¸âƒ£  è·å–è‚¡ç¥¨æ•°æ®:                                â”‚  â”‚
â”‚ â”‚    stock_info = data_provider.get_stock_info()   â”‚  â”‚
â”‚ â”‚    â†“                                              â”‚  â”‚
â”‚ â”‚    akshare.stock_individual_info_em()            â”‚  â”‚
â”‚ â”‚    è¿”å›: "è‚¡ç¥¨ä»£ç : 300748\nè‚¡ç¥¨åç§°: ..."       â”‚  â”‚
â”‚ â”‚                                                   â”‚  â”‚
â”‚ â”‚ 2ï¸âƒ£  è·å–å¸‚åœºä¿¡æ¯:                                â”‚  â”‚
â”‚ â”‚    market_info = data_provider.get_market_info() â”‚  â”‚
â”‚ â”‚    â†“                                              â”‚  â”‚
â”‚ â”‚    è¿”å›: {                                        â”‚  â”‚
â”‚ â”‚      'currency_name': 'äººæ°‘å¸',                   â”‚  â”‚
â”‚ â”‚      'currency_symbol': 'Â¥'                      â”‚  â”‚
â”‚ â”‚    }                                              â”‚  â”‚
â”‚ â”‚                                                   â”‚  â”‚
â”‚ â”‚ 3ï¸âƒ£  è·å–å¸‚åœºæ•°æ®:                                â”‚  â”‚
â”‚ â”‚    market_data = data_provider.get_market_data() â”‚  â”‚
â”‚ â”‚    â†“                                              â”‚  â”‚
â”‚ â”‚    è·å–è¡Œæƒ…æ•°æ® (ä½¿ç”¨ akshare/baostock)          â”‚  â”‚
â”‚ â”‚    è¿”å›: OHLCV æ•°æ®æˆ–è¯´æ˜æ–‡æœ¬                    â”‚  â”‚
â”‚ â”‚                                                   â”‚  â”‚
â”‚ â”‚ 4ï¸âƒ£  æ„å»º System Prompt:                          â”‚  â”‚
â”‚ â”‚    è®¾å®š LLM è§’è‰²:                                 â”‚  â”‚
â”‚ â”‚    - MarketAnalyst: æŠ€æœ¯åˆ†æå¸ˆ                    â”‚  â”‚
â”‚ â”‚    - FundamentalsAnalyst: åŸºæœ¬é¢åˆ†æå¸ˆ            â”‚  â”‚
â”‚ â”‚                                                   â”‚  â”‚
â”‚ â”‚ 5ï¸âƒ£  è°ƒç”¨ LLM åˆ†æ:                               â”‚  â”‚
â”‚ â”‚    report = llm_client.analyze(                 â”‚  â”‚
â”‚ â”‚        prompt=analysis_prompt,                  â”‚  â”‚
â”‚ â”‚        system_prompt=system_prompt              â”‚  â”‚
â”‚ â”‚    )                                             â”‚  â”‚
â”‚ â”‚    â†“                                              â”‚  â”‚
â”‚ â”‚    [HTTP POST â†’ DeepSeek API]                    â”‚  â”‚
â”‚ â”‚    â†“                                              â”‚  â”‚
â”‚ â”‚    LLM åˆ†ææ•°æ®ï¼Œç”Ÿæˆä¸­æ–‡æŠ¥å‘Š                    â”‚  â”‚
â”‚ â”‚    â†“                                              â”‚  â”‚
â”‚ â”‚    è¿”å›: "åŸºäºæ•°æ®åˆ†æï¼Œå»ºè®®... "                 â”‚  â”‚
â”‚ â”‚                                                   â”‚  â”‚
â”‚ â”‚ 6ï¸âƒ£  ä¿å­˜ç»“æœ:                                    â”‚  â”‚
â”‚ â”‚    reports["å¸‚åœºåˆ†æå¸ˆ"] = report                â”‚  â”‚
â”‚ â”‚    æˆ–                                             â”‚  â”‚
â”‚ â”‚    reports["åŸºæœ¬é¢åˆ†æå¸ˆ"] = report              â”‚  â”‚
â”‚ â”‚                                                   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚ è¿”å›åˆå¹¶çš„æŠ¥å‘Š:                                          â”‚
â”‚ {                                                        â”‚
â”‚   "å¸‚åœºåˆ†æå¸ˆ": "æŠ€æœ¯åˆ†ææŠ¥å‘Š...",                       â”‚
â”‚   "åŸºæœ¬é¢åˆ†æå¸ˆ": "åŸºæœ¬é¢åˆ†ææŠ¥å‘Š..."                    â”‚
â”‚ }                                                        â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    ğŸ’¾ ä¿å­˜åˆ° MongoDB:
    mongodb_storage.save_analysis_report(
        stock_symbol="300748",
        analysis_date="2024-01-01",
        market="Aè‚¡",
        analysts=["market", "fundamentals"],
        reports=reports,
        image_analysis=image_analysis
    )
    â†“
    æ„å»ºå“åº”:
    {
        "success": true,
        "message": "åˆ†æå®Œæˆ",
        "data": {
            "ticker": "300748",
            "date": "2024-01-01",
            "market": "Aè‚¡",
            "reports": {
                "å¸‚åœºåˆ†æå¸ˆ": "...",
                "åŸºæœ¬é¢åˆ†æå¸ˆ": "..."
            },
            "timestamp": "2024-01-01T10:00:00"
        }
    }
    â†“
è¿”å›ç»™å®¢æˆ·ç«¯ âœ…
    â†“
å‰ç«¯æ¥æ”¶å¹¶æ˜¾ç¤ºç»“æœ
```

---

## ğŸ“¡ æµå¼åˆ†ææµç¨‹ï¼ˆ@app.post("/api/analyze-stream")ï¼‰

```
å®¢æˆ·ç«¯å‘é€ HTTP POST è¯·æ±‚
    â†“
async def analyze_stock_stream(request: AnalysisRequest)
    â†“
    éªŒè¯è¯·æ±‚å‚æ•° (åŒä¸Š)
    â†“
    åˆ›å»ºå¼‚æ­¥ç”Ÿæˆå™¨: async def event_generator()
    â†“
è¿”å› StreamingResponse (media_type="text/event-stream")
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµå¼ç”Ÿæˆè¿‡ç¨‹ (åœ¨äº‹ä»¶ç”Ÿæˆå™¨ä¸­):                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚ 1ï¸âƒ£  å‘é€å¼€å§‹ä¿¡å·:                                       â”‚
â”‚    yield "data: {"event": "start", ...}\n\n"           â”‚
â”‚                                                           â”‚
â”‚ 2ï¸âƒ£  è°ƒç”¨æµå¼åˆ†æ:                                       â”‚
â”‚    async for chunk in                                    â”‚
â”‚    analyst_manager_stream.analyze_stream(...)           â”‚
â”‚    {                                                      â”‚
â”‚        # å¯¹äºæ¯ä¸ªåˆ†æå¸ˆ (å¹¶è¡Œæˆ–ä¸²è¡Œ):                    â”‚
â”‚                                                           â”‚
â”‚        3ï¸âƒ£  åˆ†æå¸ˆå¯åŠ¨æ ‡è®°:                               â”‚
â”‚            chunk = "[ANALYST_START]å¸‚åœºåˆ†æå¸ˆ"           â”‚
â”‚            â†“                                              â”‚
â”‚            yield "data: {"event":"analyst_start", ...}\n\n"
â”‚                                                           â”‚
â”‚        4ï¸âƒ£  å†…å®¹æµå¼è¾“å‡º:                                â”‚
â”‚            async for content_chunk in                   â”‚
â”‚            market_analyst.analyze_stream(...)           â”‚
â”‚            {                                              â”‚
â”‚                chunk = "æŠ€æœ¯åˆ†æçš„ä¸€éƒ¨åˆ†æ–‡æœ¬... "        â”‚
â”‚                â†“                                          â”‚
â”‚                yield "data: {"event":"content",          â”‚
â”‚                             "chunk":"..."}\n\n"         â”‚
â”‚            }                                              â”‚
â”‚                                                           â”‚
â”‚        5ï¸âƒ£  åˆ†æå¸ˆç»“æŸæ ‡è®°:                               â”‚
â”‚            chunk = "[ANALYST_END]å¸‚åœºåˆ†æå¸ˆ"             â”‚
â”‚            â†“                                              â”‚
â”‚            yield "data: {"event":"analyst_end", ...}\n\n"â”‚
â”‚                                                           â”‚
â”‚        6ï¸âƒ£  é‡å¤æ­¥éª¤ 3-5 ç”¨äºåŸºæœ¬é¢åˆ†æå¸ˆ                â”‚
â”‚                                                           â”‚
â”‚    }                                                      â”‚
â”‚                                                           â”‚
â”‚ 7ï¸âƒ£  å‘é€å®Œæˆä¿¡å·:                                       â”‚
â”‚    yield "data: {"event": "complete", ...}\n\n"        â”‚
â”‚                                                           â”‚
â”‚ 8ï¸âƒ£  ä¿å­˜å®Œæ•´ç»“æœåˆ° MongoDB (æµå¼å®Œæˆå):              â”‚
â”‚    mongodb_storage.save_analysis_report(...)            â”‚
â”‚                                                           â”‚
â”‚ 9ï¸âƒ£  é”™è¯¯å¤„ç†:                                           â”‚
â”‚    å¦‚æœå¼‚å¸¸:                                              â”‚
â”‚    yield "data: {"event": "error", ...}\n\n"           â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å‰ç«¯æ¥æ”¶ SSE äº‹ä»¶æµ:
    â”œâ”€ "start" äº‹ä»¶: æ˜¾ç¤º"åˆ†æå¼€å§‹..."
    â”œâ”€ "analyst_start" äº‹ä»¶: åˆ›å»ºæ–°çš„åˆ†æå¸ˆç»“æœåŒºåŸŸ
    â”œâ”€ "content" äº‹ä»¶: é€ä¸ªæ–‡æœ¬å—æ˜¾ç¤ºï¼ˆå“åº”å¼æ›´æ–°ï¼‰
    â”œâ”€ "analyst_end" äº‹ä»¶: æ ‡è®°è¯¥åˆ†æå¸ˆå®Œæˆ âœ“
    â””â”€ "complete" äº‹ä»¶: æ‰€æœ‰åˆ†æå®Œæˆ
    â†“
ç”¨æˆ·å®æ—¶çœ‹åˆ°åˆ†æç»“æœè¢«é€ä¸ªè¾“å‡º âœ¨
```

---

## ğŸ—ï¸ ç±»ä¸ä¾èµ–å…³ç³»å›¾

```
å…¨å±€ä½œç”¨åŸŸ (Module Level)
â”‚
â”œâ”€ llm_client: DeepSeekClient
â”‚  â”œâ”€ self._client: httpx.Client
â”‚  â”œâ”€ self._async_client: httpx.AsyncClient
â”‚  â””â”€ æ–¹æ³•:
â”‚     â”œâ”€ _chat(messages) â†’ str
â”‚     â”œâ”€ analyze(prompt, system_prompt) â†’ str
â”‚     â””â”€ analyze_stream(prompt, system_prompt) â†’ AsyncGenerator[str]
â”‚
â”œâ”€ data_provider: StockDataProvider
â”‚  â”œâ”€ self.market_info: dict
â”‚  â””â”€ æ–¹æ³•:
â”‚     â”œâ”€ get_market_info(ticker, market) â†’ dict
â”‚     â”œâ”€ get_stock_info(ticker, market) â†’ str
â”‚     â”œâ”€ get_market_data(ticker, date, market) â†’ str
â”‚     â”œâ”€ get_daily_data(ticker, start, end) â†’ DataFrame
â”‚     â””â”€ [å†…éƒ¨æ–¹æ³•] _get_china_stock_info() ç­‰
â”‚
â”œâ”€ analyst_manager: AnalystManager
â”‚  â”œâ”€ self.market_analyst: MarketAnalyst
â”‚  â”œâ”€ self.fundamentals_analyst: FundamentalsAnalyst
â”‚  â””â”€ æ–¹æ³•:
â”‚     â””â”€ analyze(ticker, date, market, analysts) â†’ Dict[str, str]
â”‚
â”œâ”€ analyst_manager_stream: AnalystManagerStream
â”‚  â”œâ”€ self.market_analyst_stream: MarketAnalystStream
â”‚  â”œâ”€ self.fundamentals_analyst_stream: FundamentalsAnalystStream
â”‚  â””â”€ æ–¹æ³•:
â”‚     â””â”€ analyze_stream(ticker, date, market, analysts) â†’ AsyncGenerator[str]
â”‚
â”œâ”€ mongodb_storage: MongoDBStorage
â”‚  â”œâ”€ self.client: pymongo.MongoClient
â”‚  â”œâ”€ self.db: pymongo.database.Database
â”‚  â”œâ”€ self.connected: bool
â”‚  â””â”€ æ–¹æ³•:
â”‚     â”œâ”€ save_analysis_report(stock_symbol, ...) â†’ ObjectId
â”‚     â””â”€ get_analysis_reports(stock_symbol, limit) â†’ List[dict]
â”‚
â””â”€ image_analyzer: ImageAnalyzer
   â”œâ”€ self.llm_client: DeepSeekClient
   â””â”€ æ–¹æ³•:
      â””â”€ analyze_image(image_path, prompt) â†’ str


Analyst ç±»å±‚æ¬¡:
â”œâ”€ MarketAnalyst (åŒæ­¥)
â”‚  â”œâ”€ __init__(llm_client, data_provider)
â”‚  â””â”€ analyze(ticker, date, market) â†’ str
â”‚
â”œâ”€ MarketAnalystStream (å¼‚æ­¥)
â”‚  â”œâ”€ __init__(llm_client, data_provider)
â”‚  â””â”€ analyze_stream(ticker, date, market) â†’ AsyncGenerator[str]
â”‚
â”œâ”€ FundamentalsAnalyst (åŒæ­¥)
â”‚  â”œâ”€ __init__(llm_client, data_provider)
â”‚  â””â”€ analyze(ticker, date, market) â†’ str
â”‚
â”œâ”€ FundamentalsAnalystStream (å¼‚æ­¥)
â”‚  â”œâ”€ __init__(llm_client, data_provider)
â”‚  â””â”€ analyze_stream(ticker, date, market) â†’ AsyncGenerator[str]
â”‚
â”œâ”€ AnalystManager (åŒæ­¥)
â”‚  â”œâ”€ __init__(llm_client, data_provider)
â”‚  â”œâ”€ self.market_analyst: MarketAnalyst
â”‚  â”œâ”€ self.fundamentals_analyst: FundamentalsAnalyst
â”‚  â””â”€ analyze(...) â†’ Dict[str, str]
â”‚
â””â”€ AnalystManagerStream (å¼‚æ­¥)
   â”œâ”€ __init__(llm_client, data_provider)
   â”œâ”€ self.market_analyst_stream: MarketAnalystStream
   â”œâ”€ self.fundamentals_analyst_stream: FundamentalsAnalystStream
   â””â”€ analyze_stream(...) â†’ AsyncGenerator[str]
```

---

## ğŸ“ å…¨å±€å˜é‡ä½œç”¨åŸŸè¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             å…¨å±€å˜é‡ç”Ÿå‘½å‘¨æœŸ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ ğŸ”´ STAGE 1: æ¨¡å—åŠ è½½æ—¶                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚ llm_client = None                                       â”‚
â”‚ data_provider = None                                    â”‚
â”‚ analyst_manager = None                                  â”‚
â”‚ analyst_manager_stream = None                           â”‚
â”‚ mongodb_storage = None                                  â”‚
â”‚ image_analyzer = None                                   â”‚
â”‚                                                          â”‚
â”‚ âš ï¸  æ­¤æ—¶æ‰€æœ‰å…¨å±€å˜é‡éƒ½æ˜¯ Noneï¼Œæ— æ³•ä½¿ç”¨ï¼               â”‚
â”‚                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ ğŸŸ¡ STAGE 2: FastAPI åº”ç”¨å¯åŠ¨                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚ @app.on_event("startup") â†’ init_components()           â”‚
â”‚                                                          â”‚
â”‚ æ‰§è¡Œåˆå§‹åŒ– (init_components):                           â”‚
â”‚   1. å£°æ˜ global å…³é”®å­— (å¾ˆé‡è¦!)                       â”‚
â”‚      global llm_client, data_provider, ...              â”‚
â”‚                                                          â”‚
â”‚   2. é€ä¸ªåˆå§‹åŒ–å…¨å±€å˜é‡:                                â”‚
â”‚      llm_client = DeepSeekClient()       # ä» .env è¯»å– â”‚
â”‚      data_provider = StockDataProvider()  # åˆå§‹åŒ–æ•°æ®  â”‚
â”‚      analyst_manager = AnalystManager(..) # æ³¨å…¥ä¾èµ–    â”‚
â”‚      ...                                                 â”‚
â”‚                                                          â”‚
â”‚ âœ…  ç°åœ¨æ‰€æœ‰å…¨å±€å˜é‡éƒ½å·²åˆå§‹åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ï¼              â”‚
â”‚                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ ğŸŸ¢ STAGE 3: å¤„ç† HTTP è¯·æ±‚                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ å½“è¯·æ±‚åˆ°è¾¾æ—¶:                                           â”‚
â”‚   @app.post("/api/analyze")                            â”‚
â”‚   async def analyze_stock(request):                    â”‚
â”‚       # ç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡                                â”‚
â”‚       reports = analyst_manager.analyze(...)           â”‚
â”‚       mongodb_storage.save_analysis_report(...)        â”‚
â”‚                                                          â”‚
â”‚ âœ…  å…¨å±€å˜é‡å·²ç»åˆå§‹åŒ–ï¼Œç›´æ¥å¯ç”¨                        â”‚
â”‚                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ global å…³é”®å­—ï¼Ÿ                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                          â”‚
â”‚ åœ¨ init_components() ä¸­:                                â”‚
â”‚                                                          â”‚
â”‚ âŒ é”™è¯¯åšæ³•:                                            â”‚
â”‚    def init_components():                              â”‚
â”‚        llm_client = DeepSeekClient()                   â”‚
â”‚        # â†‘ åˆ›å»ºçš„æ˜¯æœ¬åœ°å˜é‡ï¼Œä¸æ˜¯å…¨å±€å˜é‡ï¼             â”‚
â”‚        # å‡½æ•°ç»“æŸåå°±åˆ é™¤äº†                             â”‚
â”‚                                                          â”‚
â”‚ âœ… æ­£ç¡®åšæ³•:                                            â”‚
â”‚    def init_components():                              â”‚
â”‚        global llm_client  # å£°æ˜ä½¿ç”¨å…¨å±€å˜é‡           â”‚
â”‚        llm_client = DeepSeekClient()                   â”‚
â”‚        # â†‘ ç°åœ¨ä¿®æ”¹çš„æ˜¯æ¨¡å—çº§åˆ«çš„å…¨å±€å˜é‡               â”‚
â”‚        # å…¶ä»–å‡½æ•°éƒ½èƒ½è®¿é—®                               â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”Œ ä¾èµ–æ³¨å…¥æµç¨‹

```
init_components() åˆå§‹åŒ–æ—¶:

Step 1: åˆ›å»º LLM å®¢æˆ·ç«¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ llm_client =             â”‚
â”‚   DeepSeekClient()       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä» .env è¯»å–:            â”‚
â”‚ â€¢ DEEPSEEK_API_KEY       â”‚
â”‚ â€¢ DEEPSEEK_BASE_URL      â”‚
â”‚ â€¢ DEEPSEEK_MODEL         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
Step 2: åˆ›å»ºæ•°æ®æä¾›è€…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ data_provider =          â”‚
â”‚   StockDataProvider()    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆå§‹åŒ–å¸‚åœºä¿¡æ¯           â”‚
â”‚ (Aè‚¡/æ¸¯è‚¡/ç¾è‚¡)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
Step 3: å°† llm_client å’Œ data_provider æ³¨å…¥åˆ°åˆ†æå¸ˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ analyst_manager =                        â”‚
â”‚   AnalystManager(                        â”‚
â”‚     llm_client,      â† æ³¨å…¥             â”‚
â”‚     data_provider    â† æ³¨å…¥             â”‚
â”‚   )                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†…éƒ¨åˆ›å»º:                                â”‚
â”‚ â€¢ MarketAnalyst(llm_client, data_provider)
â”‚ â€¢ FundamentalsAnalyst(...)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
Step 4: åˆ›å»ºæµå¼ç‰ˆæœ¬ (åŒæ ·æ³¨å…¥)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ analyst_manager_stream =                 â”‚
â”‚   AnalystManagerStream(...)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†…éƒ¨åˆ›å»º:                                â”‚
â”‚ â€¢ MarketAnalystStream(...)               â”‚
â”‚ â€¢ FundamentalsAnalystStream(...)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
Step 5: åˆ›å»ºæ•°æ®åº“å­˜å‚¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mongodb_storage =        â”‚
â”‚   MongoDBStorage()       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å°è¯•è¿æ¥ MongoDB         â”‚
â”‚ â€¢ è·å– URI å’Œå‡­è¯        â”‚
â”‚ â€¢ åˆå§‹åŒ–æ•°æ®åº“è¿æ¥       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
Step 6: åˆ›å»ºå›¾ç‰‡åˆ†æå™¨ (æ³¨å…¥ llm_client)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ image_analyzer =         â”‚
â”‚   ImageAnalyzer(         â”‚
â”‚     llm_client  â† æ³¨å…¥   â”‚
â”‚   )                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç°åœ¨æ‰€æœ‰ç»„ä»¶éƒ½åˆå§‹åŒ–å¹¶äº’ç›¸æ³¨å…¥å®Œæ¯• âœ…
```

---

## ğŸ“Š API è¯·æ±‚æµç¨‹æ±‡æ€»è¡¨

| ç«¯ç‚¹ | æ–¹æ³• | è¯·æ±‚ | å“åº” | ç‰¹ç‚¹ |
|------|------|------|------|------|
| `/api/analyze` | POST | AnalysisRequest | AnalysisResponse | åŒæ­¥ï¼Œç­‰å¾…å®Œæˆ |
| `/api/analyze-stream` | POST | AnalysisRequest | StreamingResponse | å¼‚æ­¥ï¼ŒSSE æµå¼ |
| `/api/history` | GET | ticker, limit | List[Dict] | æŸ¥è¯¢å†å²è®°å½• |
| `/api/stock-info` | GET | ticker, market | Dict | è·å–è‚¡ç¥¨ä¿¡æ¯ |
| `/health` | GET | - | Dict | å¥åº·æ£€æŸ¥ |
| `/api` | GET | - | Dict | API ä¿¡æ¯ |

---

## ğŸ¯ å…³é”®æ¦‚å¿µæ€»ç»“

### 1. **å…¨å±€å˜é‡** (Global Variables)

- **å®šä¹‰ä½ç½®**: æ¨¡å—çº§åˆ« (api_server.py ç¬¬55-60è¡Œ)
- **åˆå§‹å€¼**: å…¨éƒ¨ä¸º None
- **åˆå§‹åŒ–æ—¶æœº**: åº”ç”¨å¯åŠ¨æ—¶ (@app.on_event("startup"))
- **ä½œç”¨**: åœ¨æ‰€æœ‰ HTTP è¯·æ±‚å¤„ç†å‡½æ•°ä¸­å…±äº«å¯¹è±¡å®ä¾‹

### 2. **ä¾èµ–æ³¨å…¥** (Dependency Injection)

- åœ¨ `init_components()` ä¸­åˆ›å»ºåŸºç¡€ç»„ä»¶ï¼ˆllm_client, data_providerï¼‰
- å°†è¿™äº›åŸºç¡€ç»„ä»¶ä¼ é€’ç»™æ›´é«˜çº§çš„ç»„ä»¶ï¼ˆanalyst_managerï¼‰
- é«˜çº§ç»„ä»¶ä¸éœ€è¦çŸ¥é“å¦‚ä½•åˆ›å»ºä¾èµ–ï¼Œåªéœ€ä½¿ç”¨å®ƒä»¬

### 3. **å¼‚æ­¥/æµå¼å¤„ç†** (Async/Streaming)

- åŒæ­¥åˆ†æ: å®¢æˆ·ç«¯ç­‰å¾…æœåŠ¡å™¨å®Œæˆæ‰€æœ‰åˆ†æåè¿”å›ç»“æœ
- æµå¼åˆ†æ: æœåŠ¡å™¨è¾¹åˆ†æè¾¹å‘é€æ•°æ®ï¼Œä½¿ç”¨ SSE (Server-Sent Events)
- å‰ç«¯å¯ä»¥å®æ—¶å±•ç¤ºåˆ†æç»“æœ

### 4. **æ•°æ®æµå‘** (Data Flow)

```
ç”¨æˆ·è¾“å…¥ â†’ API è¯·æ±‚ â†’ å‚æ•°éªŒè¯ â†’ æ•°æ®è·å– â†’ LLM åˆ†æ â†’ ç»“æœä¿å­˜ â†’ è¿”å›å®¢æˆ·ç«¯ â†’ UI å±•ç¤º
```

### 5. **æŒä¹…åŒ–å­˜å‚¨** (Persistence)

- MongoDB å­˜å‚¨åˆ†ææŠ¥å‘Š
- æ”¯æŒå†å²æŸ¥è¯¢
- ä¾¿äºåˆ†æå†å²æ•°æ®

---

## ğŸš¨ å¸¸è§é”™è¯¯ä¸è§£å†³

### é—®é¢˜ 1: "AttributeError: 'NoneType' object has no attribute"

**åŸå› **: å…¨å±€å˜é‡æœªåˆå§‹åŒ–å°±è¢«ä½¿ç”¨
**è§£å†³**: ç¡®ä¿åœ¨ä½¿ç”¨å‰å·²è°ƒç”¨ `init_components()`

### é—®é¢˜ 2: "NameError: name 'llm_client' is not defined"

**åŸå› **: å‡½æ•°å†…éƒ¨æ²¡æœ‰å£°æ˜ global
**è§£å†³**: åœ¨å‡½æ•°å¼€å§‹å¤„æ·»åŠ  `global llm_client, ...`

### é—®é¢˜ 3: LLM API è°ƒç”¨è¶…æ—¶

**åŸå› **: DeepSeek API å“åº”æ…¢æˆ–ç½‘ç»œé—®é¢˜
**è§£å†³**: å¢åŠ  timeout æˆ–ä½¿ç”¨æµå¼ç‰ˆæœ¬

### é—®é¢˜ 4: MongoDB è¿æ¥å¤±è´¥

**åŸå› **: MongoDB æœªå¯åŠ¨æˆ–å‡­è¯é”™è¯¯
**è§£å†³**: æ£€æŸ¥ MongoDB è¿æ¥å­—ç¬¦ä¸²å’Œå‡­è¯

---

## ğŸ“ˆ ç³»ç»Ÿç‰¹ç‚¹

âœ… **æ¨¡å—åŒ–æ¶æ„** - æ¸…æ™°çš„èŒè´£åˆ†ç¦»
âœ… **ä¾èµ–æ³¨å…¥** - å®¹æ˜“æµ‹è¯•å’Œç»´æŠ¤
âœ… **åŒæ­¥/å¼‚æ­¥åŒæ¨¡å¼** - çµæ´»é€‰æ‹©
âœ… **æµå¼è¾“å‡º** - å®æ—¶åé¦ˆ
âœ… **æ•°æ®æŒä¹…åŒ–** - MongoDB å­˜å‚¨
âœ… **é”™è¯¯å¤„ç†** - å®Œå–„çš„å¼‚å¸¸æ•è·
âœ… **æ—¥å¿—è®°å½•** - ä¾¿äºè°ƒè¯•
âœ… **CORS æ”¯æŒ** - è·¨åŸŸè¯·æ±‚
